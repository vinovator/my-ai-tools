<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi-Square Goodness of Fit Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --accent: #8B5CF6;
            --bg-body: #F3F4F6;
            --bg-surface: #ffffff;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 800px;
        }

        .sidebar {
            background: #F9FAFB;
            padding: 30px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .content-area {
            padding: 40px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section h2 {
            color: var(--text-main);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            background: #F3F4F6;
            border-color: #D1D5DB;
            color: var(--text-main);
        }

        /* Scenarios */
        .scenario-card {
            background: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .scenario-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .scenario-card.active {
            border-color: var(--primary);
            background: #EEF2FF;
            /* Light indigo tint */
            box-shadow: var(--shadow-sm);
        }

        .scenario-card h3 {
            color: var(--text-main);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scenario-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Tooltip */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--text-muted);
            color: white;
            border-radius: 50%;
            font-size: 11px;
            margin-left: 6px;
            cursor: help;
            transition: background 0.2s;
        }

        .tooltip-icon:hover {
            background: var(--primary);
        }

        /* NOTE: We are using Chart.js tooltips mostly, or custom titles. 
           The original CSS tooltip logic for icons can remain if used. */
        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 130%;
            /* Show above */
            background: #1F2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 200px;
            font-size: 12px;
            font-weight: 400;
            z-index: 100;
            pointer-events: none;
            box-shadow: var(--shadow-lg);
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .metric-card h3 {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .metric-card .detail {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
            font-size: 0.95rem;
        }

        .data-table th {
            background: #F9FAFB;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: #F9FAFB;
        }

        #dataTableContainer {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            overflow: hidden;
        }

        #dataTableContainer h2 {
            margin-bottom: 15px;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            padding-left: 5px;
        }

        /* Collapsible */
        .collapsible {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }

        /* Hypothesis Box */
        .hypothesis-box {
            background: #EFF6FF;
            /* Blue 50 */
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 30px;
        }

        .hypothesis-label {
            color: var(--primary);
        }

        /* Chart Guide */
        .chart-guide {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        /* Quiz (Base) */
        /* Note: .quiz-container is fully defined below in the "Quiz Options" section override */

        /* Tutorial */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-box {
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            max-width: 600px;
            position: relative;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .tutorial-box h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .tutorial-box p {
            font-size: 1rem;
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .tutorial-navigation {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        /* Glossary */
        .glossary-item {
            margin-bottom: 15px;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .glossary-item h4 {
            color: var(--primary);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .glossary-item p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.active {
            max-height: 2000px;
        }

        /* Quiz Container */
        .quiz-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-top: 40px;
            border: 1px solid var(--border);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            /* Initially hidden */
        }

        .quiz-container h2 {
            color: var(--primary);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
            position: relative;
        }

        .quiz-container h2::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--accent);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        /* Quiz Items */
        .quiz-question {
            background: #F9FAFB;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #E5E7EB;
        }

        .quiz-question p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
        }

        .quiz-options {
            list-style: none;
            display: grid;
            gap: 12px;
        }

        .quiz-options li {
            padding: 16px 20px;
            background: white;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .quiz-options li:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .quiz-options li.correct {
            background-color: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
            pointer-events: none;
        }

        .quiz-options li.incorrect {
            background-color: #FEF2F2;
            border-color: #EF4444;
            color: #991B1B;
            pointer-events: none;
        }

        .summary-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 30px;
            border-radius: var(--radius);
            margin-top: 30px;
            box-shadow: var(--shadow-md);
        }

        .summary-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .summary-panel p {
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 1.05rem;
            opacity: 0.95;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä Chi-Square Goodness of Fit Test</h1>
            <p>An Interactive Learning Experience</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <button class="btn" onclick="startTutorial()">üéì Start Tutorial</button>
                    <button class="btn btn-secondary" id="animBtn" onclick="toggleAnimation()">‚ñ∂Ô∏è Play
                        Animation</button>
                    <button class="btn btn-secondary" onclick="showQuiz()">üéØ Test Your Knowledge</button>
                </div>

                <div class="section">
                    <div class="section">
                        <h2>Real-World Scenarios</h2>
                        <div class="scenario-card" onclick="loadScenario('dice')"
                            onmouseover="showScenarioTooltip(event, 'A casino wants to verify their dice are fair. Each number should appear equally often (1/6 probability).')"
                            onmouseout="hideScenarioTooltip()">
                            <h3>üé≤ Fair Dice Test</h3>
                            <p>Is this casino die fair?</p>
                        </div>
                        <div class="scenario-card" onclick="loadScenario('genetics')"
                            onmouseover="showScenarioTooltip(event, 'Testing Mendel\'s Law of Independent Assortment. We expect a 9:3:3:1 ratio of traits in the offspring.')"
                            onmouseout="hideScenarioTooltip()">
                            <h3>üß¨ Genetics: Pea Plants</h3>
                            <p>Mendel's inheritance patterns</p>
                        </div>
                        <div class="scenario-card" onclick="loadScenario('traffic')"
                            onmouseover="showScenarioTooltip(event, 'A city planner checks if traffic volume is consistent across all 5 weekdays or if some days are busier.')"
                            onmouseout="hideScenarioTooltip()">
                            <h3>üöó Traffic Patterns</h3>
                            <p>Daily traffic distribution</p>
                        </div>
                        <div class="scenario-card" onclick="loadScenario('market')"
                            onmouseover="showScenarioTooltip(event, 'A company tests if 4 different product brands are equally popular among consumers (25% preference each).')"
                            onmouseout="hideScenarioTooltip()">
                            <h3>üìà Market Share</h3>
                            <p>Product preference analysis</p>
                        </div>
                    </div>

                    <div class="section">
                        <button class="collapsible" onclick="toggleGlossary()">üìö Glossary of Terms</button>
                        <div class="collapsible-content" id="glossary">
                            <div class="glossary-item">
                                <h4>Chi-Square (œá¬≤)</h4>
                                <p>A statistical test that measures the difference between observed and expected
                                    frequencies.</p>
                            </div>
                            <div class="glossary-item">
                                <h4>Null Hypothesis (H‚ÇÄ)</h4>
                                <p>The assumption that there is no significant difference between observed and expected
                                    data.</p>
                            </div>
                            <div class="glossary-item">
                                <h4>Degrees of Freedom</h4>
                                <p>Number of categories minus 1. Determines the shape of the chi-square distribution.
                                </p>
                            </div>
                            <div class="glossary-item">
                                <h4>P-Value</h4>
                                <p>Probability of obtaining results at least as extreme as observed, assuming H‚ÇÄ is
                                    true.
                                </p>
                            </div>
                            <div class="glossary-item">
                                <h4>Critical Value</h4>
                                <p>Threshold value that separates rejection and non-rejection regions.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="content-area">
                <div class="hypothesis-box" id="hypothesisContainer">
                    <div class="hypothesis-item">
                        <span class="hypothesis-label">Null Hypothesis (H‚ÇÄ):</span>
                        <span id="h0-text">Loading...</span>
                    </div>
                    <div class="hypothesis-item">
                        <span class="hypothesis-label">Alternative Hypothesis (H‚ÇÅ):</span>
                        <span id="h1-text">Loading...</span>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>œá¬≤ Statistic <span class="tooltip-icon"
                                data-tooltip="Sum of squared differences between observed and expected values, divided by expected values. Larger values suggest worse fit.">?</span>
                        </h3>
                        <div class="value" id="chiSquare">0.00</div>
                        <div class="detail">Test statistic</div>
                    </div>
                    <div class="metric-card">
                        <h3>P-Value <span class="tooltip-icon"
                                data-tooltip="Probability of seeing this data if the null hypothesis is true. Values < 0.05 suggest rejecting the null hypothesis.">?</span>
                        </h3>
                        <div class="value" id="pValue">0.000</div>
                        <div class="detail" id="decision">-</div>
                    </div>
                    <div class="metric-card">
                        <h3>Critical Value <span class="tooltip-icon"
                                data-tooltip="The threshold value at Œ±=0.05. If œá¬≤ > critical value, reject H‚ÇÄ.">?</span>
                        </h3>
                        <div class="value" id="criticalValue">0.00</div>
                        <div class="detail">at Œ± = 0.05</div>
                    </div>
                    <div class="metric-card">
                        <h3>Degrees of Freedom <span class="tooltip-icon"
                                data-tooltip="Number of categories minus 1. Determines which chi-square distribution to use.">?</span>
                        </h3>
                        <div class="value" id="degreesOfFreedom">0</div>
                        <div class="detail">n - 1</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div style="height: 400px; position: relative;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div id="dataTableContainer">
                    <h2>Data Analysis Table</h2>
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Observed (O) <span class="tooltip-icon"
                                        data-tooltip="The actual frequencies we measured or counted in our experiment.">?</span>
                                </th>
                                <th>Expected (E) <span class="tooltip-icon"
                                        data-tooltip="The frequencies we would expect if the null hypothesis is true.">?</span>
                                </th>
                                <th>(O-E)¬≤ <span class="tooltip-icon"
                                        data-tooltip="Squared difference between observed and expected values.">?</span>
                                </th>
                                <th>(O-E)¬≤/E <span class="tooltip-icon"
                                        data-tooltip="Contribution to the chi-square statistic from this category.">?</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="chart-container">
                    <div style="height: 400px; position: relative;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                    <details class="chart-guide">
                        <summary>‚ÑπÔ∏è How to read this chart?</summary>
                        <ul>
                            <li><strong>The Curve (PDF):</strong> Represents the probability of getting a specific
                                Chi-Square value just by random chance. Imagine running the experiment 10,000 times
                                with
                                a perfectly fair system‚Äîthis curve shows how the results would be distributed. Most
                                results would be near 0 (perfect fit), but occasionally you'd get higher values just
                                by
                                luck.</li>
                            <li><strong>X-Axis:</strong> The Chi-Square Statistic value (0 means perfect fit, higher
                                means worse fit).</li>
                            <li><strong>Blue Line:</strong> Your calculated statistic. Where does your data fall?
                            </li>
                            <li><strong>Red Line (Critical Value):</strong> The "Limit". If your blue line is to the
                                right of this red line (in the shaded area), your result is too extreme to be just
                                luck
                                (probability < 5%).</li>
                        </ul>
                    </details>
                    <details class="chart-guide" style="margin-top: 5px;">
                        <summary>üìâ Intuitive: How is this curve drawn?</summary>
                        <p style="padding: 10px; color: #555; line-height: 1.5;">
                            Think of this curve as a "Pile of Possibilities".
                            <br><br>
                            1. <strong>Simulation:</strong> Imagine we simulate a "null" world (e.g., a perfectly
                            fair
                            die) millions of times.
                            <br>
                            2. <strong>Calculate:</strong> For each simulation, we calculate the Chi-Square score
                            (measure of "weirdness").
                            <br>
                            3. <strong>Stack:</strong> We stack all those scores up. The curve is highest where the
                            scores are most common.
                            <br>
                            4. <strong>The Tail:</strong> The long tail to the right represents those rare,
                            super-weird
                            outcomes that shouldn't happen often if everything is fair.
                        </p>
                    </details>
                    <details class="chart-guide" style="margin-top: 5px;">
                        <summary>üßÆ How is P-Value calculated?</summary>
                        <p style="padding: 10px; color: #555; line-height: 1.5;">
                            The P-Value represents the <strong>area under the curve</strong> to the right of your
                            statistic.
                            <br><br>
                            Mathematically, it is the integral of the probability density function (PDF) from your
                            œá¬≤ value to infinity:
                            <br>
                            <code
                                style="display:block; text-align:center; margin: 10px 0; background:#eee; padding:5px;">P = ‚à´ f(x; k) dx</code>
                            <br>
                            In this app, we use a numerical approximation (<strong>series expansion</strong> of the
                            Incomplete Gamma Function) to calculate this area.
                        </p>
                    </details>
                </div>

                <div class="summary-panel" id="summaryPanel">
                    <h3>üìä What Does This Mean?</h3>
                    <p id="summaryText">Select a scenario to begin exploring hypothesis testing!</p>
                </div>

                <!-- Quiz Section -->
                <div class="quiz-container" id="quizContainer">
                    <h2>üéØ Knowledge Check</h2>
                    <div id="quizContent"></div>
                </div>
            </div>
        </div>

        <div class="tutorial-overlay" id="tutorialOverlay">
            <div class="tutorial-box">
                <h2 id="tutorialTitle">Welcome to Chi-Square Testing!</h2>
                <div id="tutorialContent">
                    <p>This tutorial will guide you through the concept of chi-square goodness of fit testing step by
                        step.
                    </p>
                </div>
                <div class="tutorial-navigation">
                    <button class="btn btn-secondary" onclick="previousTutorialStep()">‚Üê Previous</button>
                    <button class="btn" onclick="nextTutorialStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <script>
            let mainChart, distributionChart;
            let currentScenario = null;
            let tutorialStep = 0;
            let animationRunning = false;
            let animationInterval;

            const tutorialSteps = [
                {
                    title: "Welcome to Chi-Square Testing!",
                    content: "The chi-square goodness of fit test helps us determine if observed data matches an expected distribution. Let's learn how it works!"
                },
                {
                    title: "Step 1: The Question",
                    content: "We start with a question: 'Does our observed data fit the expected pattern?' For example, 'Is this die fair?' or 'Do customers prefer products equally?'"
                },
                {
                    title: "Step 2: Null Hypothesis (H‚ÇÄ)",
                    content: "We assume there IS a good fit (null hypothesis). For a fair die: H‚ÇÄ = 'Each number appears with equal probability (1/6)'."
                },
                {
                    title: "Step 3: Collect Data",
                    content: "We observe actual frequencies. For example, rolling a die 60 times and counting how many times each number appears."
                },
                {
                    title: "Step 4: Calculate Expected",
                    content: "Under H‚ÇÄ, we calculate expected frequencies. For a fair die rolled 60 times: each number should appear 60/6 = 10 times."
                },
                {
                    title: "Step 5: Chi-Square Statistic",
                    content: "œá¬≤ = Œ£[(O-E)¬≤/E]. We calculate how much observed differs from expected. Larger œá¬≤ means worse fit!"
                },
                {
                    title: "Step 6: P-Value & Decision",
                    content: "The p-value tells us: 'If H‚ÇÄ is true, what's the probability of seeing data this extreme?' If p < 0.05, we reject H‚ÇÄ."
                },
                {
                    title: "You're Ready!",
                    content: "Now try the real-world scenarios on the left. Watch how changing the data affects the chi-square statistic and p-value!"
                }
            ];

            const scenarios = {
                dice: {
                    name: "Fair Dice Test",
                    categories: ['1', '2', '3', '4', '5', '6'],
                    observed: [8, 12, 9, 11, 10, 10],
                    expected: [10, 10, 10, 10, 10, 10],
                    context: "A casino wants to verify their dice are fair. Each number should appear equally often.",
                    hypothesis: "The die is fair (each outcome has probability 1/6)",
                    alternative: "The die is biased (probabilities are not equal)"
                },
                genetics: {
                    name: "Mendel's Pea Plants",
                    categories: ['Round-Yellow', 'Round-Green', 'Wrinkled-Yellow', 'Wrinkled-Green'],
                    observed: [315, 108, 101, 32],
                    expected: [312.75, 104.25, 104.25, 34.75],
                    context: "Testing Mendel's 9:3:3:1 ratio for dihybrid cross in pea plants.",
                    hypothesis: "Traits follow Mendel's predicted 9:3:3:1 ratio",
                    alternative: "Traits do not follow the predicted 9:3:3:1 ratio"
                },
                traffic: {
                    name: "Daily Traffic Patterns",
                    categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    observed: [145, 152, 138, 165, 150],
                    expected: [150, 150, 150, 150, 150],
                    context: "A highway authority checks if traffic is evenly distributed across weekdays.",
                    hypothesis: "Traffic is equally distributed across weekdays",
                    alternative: "Traffic is not equally distributed across weekdays"
                },
                market: {
                    name: "Product Market Share",
                    categories: ['Brand A', 'Brand B', 'Brand C', 'Brand D'],
                    observed: [45, 38, 52, 65],
                    expected: [50, 50, 50, 50],
                    context: "Market research to see if consumers have equal preference for four brands.",
                    hypothesis: "All brands have equal market share",
                    alternative: "Brands do not have equal market share"
                }
            };

            const quizQuestions = [
                {
                    q: "What does the Chi-Square statistic measure?",
                    opts: ["The average of the data", "Difference between observed and expected", "The standard deviation"],
                    correct: 1
                },
                {
                    q: "If P-Value < 0.05, what do we usually do?",
                    opts: ["Reject the null hypothesis", "Accept the null hypothesis", "Recalculate the data"],
                    correct: 0
                },
                {
                    q: "What is the Null Hypothesis for a fair coin?",
                    opts: ["Heads is more likely", "Heads and Tails are equally likely", "Tails is more likely"],
                    correct: 1
                }
            ];

            document.addEventListener('DOMContentLoaded', () => {
                initCharts();
                loadScenario('dice'); // Load default
                renderQuiz();
            });

            function initCharts() {
                const ctx1 = document.getElementById('mainChart').getContext('2d');
                mainChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Observed',
                            data: [],
                            backgroundColor: 'rgba(79, 70, 229, 0.7)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }, {
                            label: 'Expected',
                            data: [],
                            backgroundColor: 'rgba(139, 92, 246, 0.7)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Observed vs Expected Frequencies', font: { size: 16, family: 'Inter', weight: 600 }, color: '#1F2937' },
                            legend: { display: true, position: 'top', labels: { font: { family: 'Inter', size: 12 }, color: '#4B5563', usePointStyle: true, boxWidth: 8 } },
                            tooltip: {
                                backgroundColor: '#1F2937',
                                titleFont: { family: 'Inter', size: 13 },
                                bodyFont: { family: 'Inter', size: 12 },
                                padding: 10,
                                cornerRadius: 8,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#F3F4F6' },
                                ticks: { font: { family: 'Inter', size: 11 }, color: '#6B7280' },
                                title: { display: true, text: 'Frequency', font: { family: 'Inter', size: 12, weight: 600 }, color: '#9CA3AF' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { family: 'Inter', size: 11 }, color: '#6B7280' }
                            }
                        }
                    }
                });

                const ctx2 = document.getElementById('distributionChart').getContext('2d');
                distributionChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Distribution',
                                data: [],
                                borderColor: '#4F46E5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                borderWidth: 2
                            },
                            {
                                label: 'Rejection Region',
                                data: [],
                                borderColor: 'transparent',
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                fill: true,
                                pointRadius: 0
                            },
                            {
                                label: 'Critical Value',
                                type: 'bar',
                                data: [],
                                backgroundColor: '#EF4444',
                                borderColor: '#EF4444',
                                borderWidth: 1,
                                barThickness: 2,
                                order: 1
                            },
                            {
                                label: 'Your Statistic',
                                type: 'bar',
                                data: [],
                                backgroundColor: '#10B981',
                                borderColor: '#10B981',
                                borderWidth: 1,
                                barThickness: 2,
                                order: 1
                            }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        plugins: {
                            title: { display: true, text: 'Chi-Square Distribution', font: { size: 16, family: 'Inter', weight: 600 }, color: '#1F2937' },
                            legend: { display: true, position: 'top', labels: { font: { family: 'Inter', size: 12 }, color: '#4B5563', usePointStyle: true, boxWidth: 8 } },
                            tooltip: {
                                backgroundColor: '#1F2937',
                                titleFont: { family: 'Inter', size: 13 },
                                bodyFont: { family: 'Inter', size: 12 },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    label: function (context) {
                                        if (context.dataset.label === 'Critical Value') {
                                            return [
                                                `Critical Value (${context.parsed.x.toFixed(2)}): The 'Limit of Normalcy'.`,
                                                `Any value beyond this point (to the right) is considered`,
                                                `statistically significant at the 5% level (Œ± = 0.05).`
                                            ];
                                        }
                                        if (context.dataset.label === 'Your Statistic') {
                                            return `Your Statistic (${context.parsed.x.toFixed(2)}): This is your calculated value.`;
                                        }
                                        return context.dataset.label + ': ' + context.parsed.x.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Probability Density', font: { family: 'Inter', size: 12, weight: 600 }, color: '#9CA3AF' },
                                grid: { color: '#F3F4F6' },
                                ticks: { font: { family: 'Inter', size: 11 }, color: '#6B7280' }
                            },
                            x: {
                                title: { display: true, text: 'œá¬≤ Value', font: { family: 'Inter', size: 12, weight: 600 }, color: '#9CA3AF' },
                                grid: { display: false },
                                ticks: { font: { family: 'Inter', size: 11 }, color: '#6B7280' }
                            }
                        }
                    }
                });
            }

            function loadScenario(scenarioKey) {
                currentScenario = JSON.parse(JSON.stringify(scenarios[scenarioKey])); // Deep copy

                document.querySelectorAll('.scenario-card').forEach(card => card.classList.remove('active'));
                const card = document.querySelector(`.scenario-card[onclick="loadScenario('${scenarioKey}')"]`);
                if (card) card.classList.add('active');

                // Update Hypothesis Text
                document.getElementById('h0-text').textContent = currentScenario.hypothesis;
                document.getElementById('h1-text').textContent = currentScenario.alternative;

                updateVisualization();
            }

            function updateVisualization() {
                if (!currentScenario) return;

                // Update Chart
                mainChart.data.labels = currentScenario.categories;
                mainChart.data.datasets[0].data = currentScenario.observed;
                mainChart.data.datasets[1].data = currentScenario.expected;
                mainChart.options.plugins.title.text = currentScenario.name;
                mainChart.update();

                calculateChiSquare();
                updateDataTable();
                updateDistribution();
                updateSummary();
            }

            function calculateChiSquare() {
                const observed = currentScenario.observed;
                const expected = currentScenario.expected;

                let chiSquare = 0;
                for (let i = 0; i < observed.length; i++) {
                    chiSquare += Math.pow(observed[i] - expected[i], 2) / expected[i];
                }

                const df = observed.length - 1;
                const criticalValue = getCriticalValue(df, 0.05);
                const pValue = chiSquarePValue(chiSquare, df);

                document.getElementById('chiSquare').textContent = chiSquare.toFixed(2);
                document.getElementById('pValue').textContent = pValue.toFixed(4);
                document.getElementById('criticalValue').textContent = criticalValue.toFixed(2);
                document.getElementById('degreesOfFreedom').textContent = df;

                const decision = pValue < 0.05 ? 'Reject H‚ÇÄ' : 'Fail to Reject H‚ÇÄ';
                const decisionEl = document.getElementById('decision');
                decisionEl.textContent = decision;
                decisionEl.style.color = pValue < 0.05 ? '#EF4444' : '#10B981'; // Red for reject, Green for fail-to-reject (good fit)
                decisionEl.style.fontWeight = 'bold';
            }

            function updateDataTable() {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';

                const observed = currentScenario.observed;
                const expected = currentScenario.expected;
                let totalContribution = 0;

                for (let i = 0; i < observed.length; i++) {
                    const diff = observed[i] - expected[i];
                    const diffSquared = Math.pow(diff, 2);
                    const contribution = diffSquared / expected[i];
                    totalContribution += contribution;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                    <td><strong>${currentScenario.categories[i]}</strong></td>
                    <td>${observed[i]}</td>
                    <td>${expected[i].toFixed(2)}</td>
                    <td>${diffSquared.toFixed(2)}</td>
                    <td>${contribution.toFixed(4)}</td>
                `;
                }

                // Add Total Row
                const totalRow = tbody.insertRow();
                totalRow.style.backgroundColor = '#e6fffa'; // Light teal highlighting
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                <td colspan="4" style="text-align: right; color: #667eea;">Total (œá¬≤ Statistic):</td>
                <td style="color: #667eea; font-size: 1.1em;">${totalContribution.toFixed(2)}</td>
            `;
            }

            function updateDistribution() {
                const df = currentScenario.observed.length - 1;
                const currentChiSquare = parseFloat(document.getElementById('chiSquare').textContent);
                const criticalVal = parseFloat(document.getElementById('criticalValue').textContent);

                const labels = [];
                const pdfData = [];
                const rejectionData = [];
                const criticalLineData = [];
                const statLineData = [];

                // Limit x axis based on chi-square value to show relevant part of tail
                const maxX = Math.max(20, currentChiSquare + 5, criticalVal + 5);

                for (let x = 0; x <= maxX; x += 0.1) {
                    const y = chiSquarePDF(x, df);
                    labels.push(x.toFixed(1));

                    pdfData.push({ x: x, y: y });

                    // Rejection Region (Fill only after critical value)
                    if (x >= criticalVal) {
                        rejectionData.push({ x: x, y: y });
                    } else {
                        rejectionData.push({ x: x, y: null }); // No fill
                    }

                    // Critical Value Line (vertical line @ criticalVal)
                    // Chart.js hack: We can't easily do vertical lines in line chart without plugins or scatter data.
                    // But since we have many points, we can approximate it or use scatter point style.
                    // Better approach with standard line chart:
                    // We won't draw a line dataset like this. We will just shade the region.
                    // The prompt asked for vertical lines. Let's do it by finding the closest X index.
                }

                // Re-think: Simplest way to show vertical lines in Chart.js without plugins
                // is to use a separate scatter dataset with 2 points: (val, 0) and (val, max_y)
                // But we have type: 'line'. We can mix types if needed, or just use the annotation idea.

                // Let's stick to the datasets we defined:
                // 0: PDF
                // 1: Rejection Region
                // 2: Critical Value Line -> We'll construct a dataset that spikes at Critical Value
                // 3: Statistic Line -> Spikes at Statistic

                // Actually, simpler: Just create a dataset with [ {x: val, y: 0}, {x: val, y: maxY} ]
                // But main chart uses labels (indices).

                // To make "vertical lines" work on a category-axis line chart (labels array):
                // We need to find the label index closest to the value.

                // Let's refill data arrays mapping to labels
                const pdfPoints = [];
                const rejectionPoints = [];
                const criticalPoints = [];
                const statPoints = [];

                // Find max Y for scaling lines
                let peakY = df > 2 ? chiSquarePDF(df - 2, df) : chiSquarePDF(0.1, df); // Mode is at k-2 for k>2
                if (!isFinite(peakY)) peakY = 0.5;

                for (let i = 0; i < labels.length; i++) {
                    const x = parseFloat(labels[i]);
                    const y = chiSquarePDF(x, df);

                    pdfPoints.push(y);

                    // Rejection Region
                    if (x >= criticalVal) {
                        rejectionPoints.push(y);
                    } else {
                        rejectionPoints.push(null);
                    }

                    // Vertical Lines (Approximate to nearest 0.1 bin)
                    // Critical Value
                    if (Math.abs(x - criticalVal) < 0.05) {
                        criticalPoints.push(peakY);
                    } else {
                        criticalPoints.push(null);
                    }

                    // Statistic Value
                    if (Math.abs(x - currentChiSquare) < 0.05) {
                        statPoints.push(peakY);
                    } else {
                        statPoints.push(null);
                    }
                }

                distributionChart.data.labels = labels;
                distributionChart.data.datasets[0].data = pdfPoints;
                distributionChart.data.datasets[1].data = rejectionPoints;
                distributionChart.data.datasets[2].data = criticalPoints;
                distributionChart.data.datasets[3].data = statPoints;

                distributionChart.update();
            }

            function chiSquarePDF(x, df) {
                if (x <= 0) return 0;
                const k = df / 2;
                return (1 / (Math.pow(2, k) * gamma(k))) * Math.pow(x, k - 1) * Math.exp(-x / 2);
            }

            function gamma(n) {
                if (n === 1) return 1;
                if (n === 0.5) return Math.sqrt(Math.PI);
                return (n - 1) * gamma(n - 1); // Simple recursion for integers and half-integers
            }

            // Approximate P-Value for visualization purposes
            function chiSquarePValue(chiSquare, df) {
                // Very rough approximation or use table lookup for JS simplicity
                // or a proper integral. 
                // Implementing a robust one is complex, let's use a simpler heuristic or the 
                // Gamma incomplete function if needed.
                // For this UI, let's use a simple approximation for small DF

                // Actually, let's use the provided logic from the user's snippet which seemed to have an implementation
                let sum = 0;
                let term = 1;
                for (let i = 0; i < 100; i++) {
                    sum += term;
                    term *= chiSquare / (df + 2 * i);
                }
                return Math.max(0, 1 - (Math.pow(chiSquare / 2, df / 2) * Math.exp(-chiSquare / 2) * sum / gamma(df / 2 + 1)));
            }

            function getCriticalValue(df, alpha) {
                const criticalValues = {
                    1: 3.841, 2: 5.991, 3: 7.815, 4: 9.488,
                    5: 11.070, 6: 12.592, 7: 14.067, 8: 15.507
                };
                return criticalValues[df] || 0;
            }

            function updateSummary() {
                if (!currentScenario) return;

                const pValue = parseFloat(document.getElementById('pValue').textContent);
                const decision = pValue < 0.05
                    ? "The difference is <strong>statistically significant</strong> (Reject H‚ÇÄ)."
                    : "The difference is <strong>not statistically significant</strong> (Fail to Reject H‚ÇÄ).";

                const explanation = pValue < 0.05
                    ? `Evidence suggests the observed data does NOT fit the expected distribution for ${currentScenario.name}.`
                    : `Observed data matches the expected distribution for ${currentScenario.name} reasonably well.`;

                document.getElementById('summaryText').innerHTML =
                    `${decision} <br><br> ${explanation} <br><br> Context: ${currentScenario.context}`;
            }

            // --- Interaction Functions ---

            function startTutorial() {
                tutorialStep = 0;
                document.getElementById('tutorialOverlay').classList.add('active');
                updateTutorialUI();
            }

            function closeTutorial() {
                document.getElementById('tutorialOverlay').classList.remove('active');
            }

            function nextTutorialStep() {
                if (tutorialStep < tutorialSteps.length - 1) {
                    tutorialStep++;
                    updateTutorialUI();
                } else {
                    closeTutorial();
                }
            }

            function previousTutorialStep() {
                if (tutorialStep > 0) {
                    tutorialStep--;
                    updateTutorialUI();
                }
            }

            function updateTutorialUI() {
                const step = tutorialSteps[tutorialStep];
                document.getElementById('tutorialTitle').innerText = step.title;
                document.getElementById('tutorialContent').innerHTML = `<p>${step.content}</p>`;
            }

            function toggleAnimation() {
                const btn = document.getElementById('animBtn');
                if (animationRunning) {
                    clearInterval(animationInterval);
                    animationRunning = false;
                    btn.textContent = "‚ñ∂Ô∏è Play Animation";
                    // Restore original values
                    loadScenario(Object.keys(scenarios).find(key => scenarios[key].name === currentScenario.name));
                } else {
                    animationRunning = true;
                    btn.textContent = "‚èπ Stop Animation";

                    // Animate: randomly perturb observed values
                    const baseObserved = [...currentScenario.observed];
                    animationInterval = setInterval(() => {
                        const perturbed = baseObserved.map(v => Math.max(0, Math.round(v + (Math.random() - 0.5) * (v * 0.2)))); // +/- 10%

                        mainChart.data.datasets[0].data = perturbed;
                        mainChart.update();

                        // Update stats live!
                        currentScenario.observed = perturbed;
                        calculateChiSquare();
                        updateDataTable();
                    }, 500);
                }
            }

            function toggleGlossary() {
                document.getElementById('glossary').classList.toggle('active');
            }

            function showQuiz() {
                const quizContainer = document.getElementById('quizContainer');
                quizContainer.style.display = quizContainer.style.display === 'none' ? 'block' : 'none';
                quizContainer.scrollIntoView({ behavior: 'smooth' });
            }

            function renderQuiz() {
                const container = document.getElementById('quizContent');
                container.innerHTML = quizQuestions.map((q, i) => `
                <div class="quiz-question">
                    <p><strong>Q${i + 1}: ${q.q}</strong></p>
                    <ul class="quiz-options">
                        ${q.opts.map((opt, optIndex) => `
                            <li onclick="checkAnswer(this, ${i}, ${optIndex})">${opt}</li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');
            }

            function checkAnswer(el, qIndex, optIndex) {
                const isCorrect = quizQuestions[qIndex].correct === optIndex;
                if (isCorrect) {
                    el.classList.add('correct');
                    el.textContent += " ‚úÖ";
                } else {
                    el.classList.add('incorrect');
                    el.textContent += " ‚ùå";
                }
            }

            // --- Tooltip Logic ---
            let tooltipEl = null;

            function showScenarioTooltip(e, text) {
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.style.position = 'fixed'; // Use fixed to ignore parent scroll/overflow
                    tooltipEl.style.background = '#333';
                    tooltipEl.style.color = '#fff';
                    tooltipEl.style.padding = '12px';
                    tooltipEl.style.borderRadius = '5px';
                    tooltipEl.style.maxWidth = '250px';
                    tooltipEl.style.fontSize = '13px';
                    tooltipEl.style.zIndex = '100000';
                    tooltipEl.style.pointerEvents = 'none'; // Ensure mouse events pass through
                    tooltipEl.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
                    tooltipEl.style.lineHeight = '1.4';
                    document.body.appendChild(tooltipEl);
                }
                tooltipEl.textContent = text;
                tooltipEl.style.display = 'block';

                // Position calculation
                const rect = e.currentTarget.getBoundingClientRect();
                // Position to the right of the element
                let left = rect.right + 10;
                let top = rect.top + (rect.height / 2) - (tooltipEl.offsetHeight / 2);

                // Boundary checks (if off screen to right, switch to left?)
                // For now, assume sidebar is on left, so right is safe for "desktop".

                tooltipEl.style.left = left + 'px';
                tooltipEl.style.top = top + 'px';
            }

            function hideScenarioTooltip() {
                if (tooltipEl) {
                    tooltipEl.style.display = 'none';
                }
            }
        </script>
</body>

</html>